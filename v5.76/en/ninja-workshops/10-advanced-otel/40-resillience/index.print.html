<!doctype html><html lang=en dir=ltr itemscope itemtype=http://schema.org/Article data-r-output-format=print><head><meta charset=utf-8><meta name=viewport content="height=device-height,width=device-width,initial-scale=1,minimum-scale=1"><meta name=generator content="Hugo 0.134.3"><meta name=generator content="Relearn 7.2.1"><meta name=description content="We will walk through how to use OpenTelemetry Collector’s file_storage extension to build resilience into your telemetry pipeline. Specifically, we will demonstrate how to use the file storage extension for checkpointing, managing retries, and handling temporary failures effectively.
The goal is to show how this configuration allows your OpenTelemetry Collector to reliably store intermediate states on disk, ensuring that no data is lost during network failures, and that the collector can resume where it left off."><meta name=author content><meta name=twitter:card content="summary"><meta name=twitter:title content="Building Resilience in OpenTelemetry Collector Using the File Storage Extension :: Splunk Observability Cloud Workshops"><meta name=twitter:description content="We will walk through how to use OpenTelemetry Collector’s file_storage extension to build resilience into your telemetry pipeline. Specifically, we will demonstrate how to use the file storage extension for checkpointing, managing retries, and handling temporary failures effectively.
The goal is to show how this configuration allows your OpenTelemetry Collector to reliably store intermediate states on disk, ensuring that no data is lost during network failures, and that the collector can resume where it left off."><meta property="og:url" content="https://splunk.github.io/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/40-resillience/index.html"><meta property="og:site_name" content="Splunk Observability Cloud Workshops"><meta property="og:title" content="Building Resilience in OpenTelemetry Collector Using the File Storage Extension :: Splunk Observability Cloud Workshops"><meta property="og:description" content="We will walk through how to use OpenTelemetry Collector’s file_storage extension to build resilience into your telemetry pipeline. Specifically, we will demonstrate how to use the file storage extension for checkpointing, managing retries, and handling temporary failures effectively.
The goal is to show how this configuration allows your OpenTelemetry Collector to reliably store intermediate states on disk, ensuring that no data is lost during network failures, and that the collector can resume where it left off."><meta property="og:locale" content="en"><meta property="og:type" content="website"><meta itemprop=name content="Building Resilience in OpenTelemetry Collector Using the File Storage Extension :: Splunk Observability Cloud Workshops"><meta itemprop=description content="We will walk through how to use OpenTelemetry Collector’s file_storage extension to build resilience into your telemetry pipeline. Specifically, we will demonstrate how to use the file storage extension for checkpointing, managing retries, and handling temporary failures effectively.
The goal is to show how this configuration allows your OpenTelemetry Collector to reliably store intermediate states on disk, ensuring that no data is lost during network failures, and that the collector can resume where it left off."><meta itemprop=dateModified content="2025-01-21T16:39:23+01:00"><meta itemprop=wordCount content="749"><title>Building Resilience in OpenTelemetry Collector Using the File Storage Extension :: Splunk Observability Cloud Workshops</title>
<link href=https://splunk.github.io/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/40-resillience/index.html rel=canonical type=text/html title="Building Resilience in OpenTelemetry Collector Using the File Storage Extension :: Splunk Observability Cloud Workshops"><link href=/observability-workshop/v5.76/images/favicon.ico?1737480558 rel=icon type=image/x-icon sizes=any><link href=/observability-workshop/v5.76/css/fontawesome-all.min.css?1737480558 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.76/css/fontawesome-all.min.css?1737480558 rel=stylesheet></noscript><link href=/observability-workshop/v5.76/css/auto-complete.css?1737480558 rel=stylesheet media=print onload='this.media="all",this.onload=null'><noscript><link href=/observability-workshop/v5.76/css/auto-complete.css?1737480558 rel=stylesheet></noscript><link href=/observability-workshop/v5.76/css/perfect-scrollbar.min.css?1737480558 rel=stylesheet><link href=/observability-workshop/v5.76/css/theme.min.css?1737480558 rel=stylesheet><link href=/observability-workshop/v5.76/css/format-print.min.css?1737480558 rel=stylesheet id=R-format-style><script>window.relearn=window.relearn||{},window.relearn.relBasePath="../../../..",window.relearn.relBaseUri="../../../../../..",window.relearn.absBaseUri="https://splunk.github.io/observability-workshop/v5.76",window.relearn.min=`.min`,window.relearn.disableAnchorCopy=!1,window.relearn.disableAnchorScrolling=!1,window.relearn.themevariants=["auto","splunk-light","splunk-dark"],window.relearn.customvariantname="my-custom-variant",window.relearn.changeVariant=function(e){var t=document.documentElement.dataset.rThemeVariant;window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e),document.documentElement.dataset.rThemeVariant=e,t!=e&&document.dispatchEvent(new CustomEvent("themeVariantLoaded",{detail:{variant:e,oldVariant:t}}))},window.relearn.markVariant=function(){var t=window.localStorage.getItem(window.relearn.absBaseUri+"/variant"),e=document.querySelector("#R-select-variant");e&&(e.value=t)},window.relearn.initVariant=function(){var e=window.localStorage.getItem(window.relearn.absBaseUri+"/variant")??"";e==window.relearn.customvariantname||(!e||!window.relearn.themevariants.includes(e))&&(e=window.relearn.themevariants[0],window.localStorage.setItem(window.relearn.absBaseUri+"/variant",e)),document.documentElement.dataset.rThemeVariant=e},window.relearn.initVariant(),window.relearn.markVariant(),window.T_Copy_to_clipboard=`Copy to clipboard`,window.T_Copied_to_clipboard=`Copied to clipboard!`,window.T_Copy_link_to_clipboard=`Copy link to clipboard`,window.T_Link_copied_to_clipboard=`Copied link to clipboard!`,window.T_Reset_view=`Reset view`,window.T_View_reset=`View reset!`,window.T_No_results_found=`No results found for "{0}"`,window.T_N_results_found=`{1} results found for "{0}"`</script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web.js crossorigin=anonymous></script><script src=https://cdn.signalfx.com/o11y-gdi-rum/latest/splunk-otel-web-session-recorder.js crossorigin=anonymous></script><script>SplunkRum.init({realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA",applicationName:"observability-workshop",deploymentEnvironment:"splunk.github.io",version:"1.0"}),SplunkSessionRecorder.init({app:"observability-workshop",realm:"us1",rumAccessToken:"dp3FKraOS_wVhe-l7eCOsA"})</script></script><style>:root{--MAIN-WIDTH-MAX:130rem;--MENU-WIDTH-L:23rem}</style></head><body class="mobile-support print disableInlineCopyToClipboard" data-url=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/40-resillience/index.html><div id=R-body class=default-animation><div id=R-body-overlay></div><nav id=R-topbar><div class=topbar-wrapper><div class=topbar-sidebar-divider></div><div class="topbar-area topbar-area-start" data-area=start><div class="topbar-button topbar-button-sidebar" data-content-empty=disable data-width-s=show data-width-m=hide data-width-l=hide><button class=topbar-control onclick=toggleNav() type=button title="Menu (CTRL+ALT+n)"><i class="fa-fw fas fa-bars"></i></button></div><div class="topbar-button topbar-button-toc" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title="Table of Contents (CTRL+ALT+t)"><i class="fa-fw fas fa-list-alt"></i></button><div class=topbar-content><div class=topbar-content-wrapper><nav class=TableOfContents><ul><li><ul><li><a href=#setup>Setup</a></li></ul></li></ul></nav></div></div></div></div><ol class="topbar-breadcrumbs breadcrumbs highlightable" itemscope itemtype=http://schema.org/BreadcrumbList><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.76/en/index.html><span itemprop=name>Splunk Observability Workshops</span></a><meta itemprop=position content="1">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.76/en/ninja-workshops/index.html><span itemprop=name>Ninja Workshops</span></a><meta itemprop=position content="2">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><a itemprop=item href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/index.html><span itemprop=name>Advanced OpenTelemetry</span></a><meta itemprop=position content="3">&nbsp;>&nbsp;</li><li itemscope itemtype=https://schema.org/ListItem itemprop=itemListElement><span itemprop=name>4. Resilience</span><meta itemprop=position content="4"></li></ol><div class="topbar-area topbar-area-end" data-area=end><div class="topbar-button topbar-button-print" data-content-empty=disable data-width-s=area-more data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/40-resillience/index.print.html title="Print whole chapter (CTRL+ALT+p)"><i class="fa-fw fas fa-print"></i></a></div><div class="topbar-button topbar-button-prev" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/30-filelog/1-agent-filelog/index.html title="Configure the filelog receiver in the agent (🡐)"><i class="fa-fw fas fa-chevron-left"></i></a></div><div class="topbar-button topbar-button-next" data-content-empty=disable data-width-s=show data-width-m=show data-width-l=show><a class=topbar-control href=/observability-workshop/v5.76/en/ninja-workshops/10-advanced-otel/40-resillience/1-test-resilience/index.html title="Test your Resilience Setup (🡒)"><i class="fa-fw fas fa-chevron-right"></i></a></div><div class="topbar-button topbar-button-more" data-content-empty=hide data-width-s=show data-width-m=show data-width-l=show><button class=topbar-control onclick=toggleTopbarFlyout(this) type=button title=More><i class="fa-fw fas fa-ellipsis-v"></i></button><div class=topbar-content><div class=topbar-content-wrapper><div class="topbar-area topbar-area-more" data-area=more></div></div></div></div></div></div></nav><div id=R-main-overlay></div><main id=R-body-inner class="highlightable ninja-workshops" tabindex=-1><div class=flex-block-wrapper><article class=default><header class=headline></header><h1 id=building-resilience-in-opentelemetry-collector-using-the-file-storage-extension>Building Resilience in OpenTelemetry Collector Using the File Storage Extension</h1><span class="badge cstyle primary badge-with-title"><span class=badge-title><i class="fa-fw fas fa-clock"></i></span><span class=badge-content>10 minutes</span>
</span>&nbsp;<p>We will walk through how to use OpenTelemetry Collector’s <code>file_storage</code> extension to build resilience into your telemetry pipeline. Specifically, we will demonstrate how to use the file storage extension for checkpointing, managing retries, and handling temporary failures effectively.</p><p>The goal is to show how this configuration allows your OpenTelemetry Collector to reliably store intermediate states on disk, ensuring that no data is lost during network failures, and that the collector can resume where it left off.</p><details open class="box cstyle notices primary"><summary class=box-label><i class="fa-fw fas fa-lightbulb"></i>
Tip</summary><div class=box-content><ul><li>This will only be useful if the connections fails for a short period like up to 15 minutes or so. If the connection is down for longer periods, the backend will drop the data anyways because the timing&rsquo;s are too far out of synch.</li><li>This will works for logs, but we will introduce a more robust solution in one of the upcoming collector builds.</li></ul></div></details><h3 id=setup>Setup</h3><p>Create a new sub directory called <code>4-resilience</code> and copy the content from <code>3-filelog</code> across and remove any *.out file. Your starting point for this exercise should be:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=cl>WORKSHOP
</span></span><span class=line><span class=cl>├── 1-agent
</span></span><span class=line><span class=cl>├── 2-gateway
</span></span><span class=line><span class=cl>├── 3-filelog
</span></span><span class=line><span class=cl>├── 4-resilience
</span></span><span class=line><span class=cl>│   ├── agent.yaml
</span></span><span class=line><span class=cl>│   ├── gateway.yaml
</span></span><span class=line><span class=cl>│   ├── log-gen.sh
</span></span><span class=line><span class=cl>│   ├── quotes.log
</span></span><span class=line><span class=cl>│   └── trace.json
</span></span><span class=line><span class=cl>└── otelcol</span></span></code></pre></div><p>In this exercise we are going to update the agent.yaml by adding an <code>extensions:</code> section.
This new section in an OpenTelemetry configuration YAML is used to define optional components that enhance or modify the behavior of the OpenTelemetry Collector. These components don’t handle telemetry data directly but provide additional capabilities or services to the Collector.
The first exercise will be providing <strong>Checkpointing</strong> with the <code>file_storage</code> extension.<br>The <code>file_storage</code> extension is used to ensure that the OpenTelemetry Collector can persist checkpoints to disk. This is especially useful in cases where there are network failures or restarts. This way, the collector can recover from where it left off without losing data.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>Let&rsquo;s add the extension part first:</p><ol><li><strong>Add</strong> <code>extensions:</code> <strong>section</strong>: Place this at the top of the <code>agent.yaml</code>.</li><li><strong>Add</strong> <code>file_storage</code> <strong>extension</strong>: Under the <strong>extensions</strong> section. Name it <code>/checkpoint:</code>.</li><li><strong>Add</strong> <code>directory:</code> <strong>key</strong>: under the <code>file_storage</code> extension and set it to a value of <code>"./checkpoint-folder"</code></li><li><strong>Add</strong> <code>create_directory:</code> <strong>key</strong>: Set the Value to <code>true</code>.</li><li><strong>Add</strong> <code>timeout:</code> <strong>key</strong>: Set the value to <code>1s</code>.</li><li><strong>Add</strong> <code>compaction:</code> <strong>key</strong> section.</li><li><strong>Add</strong> <code>on_start:</code> <strong>key</strong>: Under the <code>compaction:</code> section, set the value to ``true`.</li><li><strong>Add</strong> <code>directory:</code> <strong>key</strong>: Set the value to <code>./checkpoint-folder/tmp</code>.</li><li><strong>Add</strong> <code>max_transaction_size:</code> <strong>key</strong>: Set it to a value of <code>65_536</code></li></ol></div></details><p><strong>Explanation:</strong></p><ul><li><code>directory: ./checkpoint-folder</code>: Defines the folder where checkpoint files will be stored.</li><li><code>create_directory: true</code>: Ensures that the directory is created if it doesn’t already exist.</li><li><code>timeout: 1s</code>: Specifies a timeout for file operations related to the checkpointing.</li><li><code>compaction</code>: Ensures that old checkpoint data is compacted periodically.<ul><li><code>on_start: true</code> : Determines whether the compaction process begins immediately when the OpenTelemetry Collector starts.</li><li><code>directory:</code> <code>./checkpoint-folder/tmp</code>: Specifies the directory used for compaction (as a midstep).</li><li><code>max_transaction_size</code> defines the size limit for checkpoint transactions before compaction occurs.</li></ul></li></ul><p>The next exercise is modifying the <code>otlphttp:</code> exporter where retries and queueing are configured.</p><details open class="box cstyle notices green"><summary class=box-label><i class="fa-fw fas fa-running"></i>
Exercise</summary><div class=box-content><p>We are going to extend the existing <code>otlphttp</code> exporter:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>exporters</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>otlphttp</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>endpoint</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;localhost:5317&#34;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nt>headers</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>      </span><span class=nt>X-SF-Token</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;FAKE_SPLUNK_ACCESS_TOKEN&#34;</span><span class=w> </span><span class=c># or your own version of a token</span></span></span></code></pre></div><p><strong>Steps:</strong></p><ol><li><strong>Add</strong> <code>tls:</code> <strong>key</strong>: Place at the same indent level as <code>headers:</code>.</li><li><strong>Add</strong> <code>insecure:</code> <strong>key</strong>: Under the <code>tls:</code> key and set its value to <code>true</code>.</li><li><strong>Add</strong> <code>retry_on_failure:</code> <strong>key</strong>: Place at the same indent level as <code>headers:</code>.</li><li><strong>Add</strong> <code>enabled:</code> <strong>key</strong>: Under the <code>retry_on_failure:</code> key and set its value to <code>true</code>.</li><li><strong>Add</strong> <code>sending_queue:</code> <strong>key</strong>:</li><li><strong>Add</strong> <code>enabled:</code> <strong>key</strong>: Under the <code>sending_queue:</code> key and set its value to <code>true</code>.</li><li><strong>Add</strong> <code>num_consumers:</code> <strong>key</strong>: Set its value to <code>10</code></li><li><strong>Add</strong> <code>queue_size:</code> <strong>key</strong>: Set its value to <code>10000</code></li><li><strong>Add</strong> <code>storage:</code> <strong>key</strong>: Set its value to <code>file_storage/checkpoint</code></li></ol></div></details><p><strong>Explanation:</strong></p><ul><li><code>retry_on_failure.enabled: true</code>: Enables retrying when there is a failure in sending data to the OTLP gateway.</li><li><code>sending_queue</code>: Configures an internal queue to store data that couldn’t be sent. The <code>storage</code> option links the queue to the <code>file_storage/checkpoint</code> extension, ensuring resilience even in case of network failures.<ul><li><code>num_consumers: 10</code>: Specifies the number of consumers reading from the queue.</li><li><code>queue_size: 10000</code>: The maximum size of the queue.</li><li><code>storage: file_storage/checkpoint</code>: Specifies that the queue state will be backed up in the file system.</li></ul></li></ul><p>Again, validate the agent configuration using <strong><a href=https://www.otelbin.io/ rel=external target=_blank>otelbin.io</a></strong> for spelling mistakes etc. Your <code>Logs:</code> pipeline should like this:</p><p><a href=#R-image-0be75d999303e8b249364869ce2224b7 class=lightbox-link><img alt="logs from otelbin" class="noborder lazy lightbox noshadow figure-image" loading=lazy src=../images/filelog-3-1-logs.png style=height:auto;width:auto></a>
<a href=javascript:history.back(); class=lightbox-back id=R-image-0be75d999303e8b249364869ce2224b7><img alt="logs from otelbin" class="noborder lazy lightbox noshadow lightbox-image" loading=lazy src=../images/filelog-3-1-logs.png></a></p><p>This setup ensures your OpenTelemetry Collector can handle network interruptions gracefully by storing telemetry data on disk and retrying failed transmissions. It combines checkpointing for recovery and queueing for efficient retries, making your pipeline more resilient and reliable. Now, let’s test this configuration!</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 21, 2025</span></span></footer></article><section><h1 class=a11y-only>Subsections of 4. Resilience</h1><article class=default><header class=headline></header><h1 id=test-your-resilience-setup>Test your Resilience Setup</h1><h3 id=step-1-setup-test-environment>Step 1: Setup Test environment</h3><p>In this section we are going to simulate an out age on the network and see if our configuration helps the Collector recover from that issue:</p><ol><li><p><strong>Run the Gateway</strong>
Now, run the OpenTelemetry Collector using the existing gateway configuration file. You can do this by executing the following command in your terminal:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config gateway.yaml</span></span></code></pre></div></li><li><p><strong>Run the Agent</strong>
Next, run the OpenTelemetry Collector using the configuration file you just created. You can do this by executing the following command in your terminal:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>../otelcol --config agent.yaml</span></span></code></pre></div><p>This will start the collector with the resilience configurations specified in the YAML file.</p></li><li><p><strong>Run the log-gen script</strong>
To generate traffic, we going to start our Log generating script:</p><div class="highlight wrap-code"><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>./log-gen.sh </span></span></code></pre></div></li></ol><h3 id=step-2-testing-the-resilience>Step 2: Testing the Resilience</h3><p>To test the resilience built into the system:</p><ol><li><p><strong>Simulate Network Failure:</strong>
Temporarily stop the OTLP receiver or shut down the endpoint where the telemetry data is being sent. You should see the retry mechanism kicking in, as the collector will attempt to resend the data.</p></li><li><p><strong>Check the Checkpoint Folder:</strong>
After a few retries, inspect the <code>./checkpoint-folder</code> directory. You should see checkpoint files stored there, which contain the serialized state of the queue.</p></li><li><p><strong>Restart the Collector:</strong>
Restart the OpenTelemetry Collector after stopping the OTLP receiver. The collector will resume sending data from the last checkpointed state, without losing any data.</p></li><li><p><strong>Inspect Logs and Files:</strong>
Inspect the logs to see the retry attempts. The <code>debug</code> exporter will output detailed logs, which should show retry attempts and any failures.</p></li></ol><h3 id=conclusion>Conclusion</h3><p>In this section, you learned how to enhance the resilience of the OpenTelemetry Collector by configuring the <code>file_storage/checkpoint</code> extension, setting up retry mechanisms for the OTLP exporter, and using a sending queue backed by file storage for storing data during temporary failures.</p><p>By leveraging file storage for checkpointing and queue persistence, you can ensure that your telemetry pipeline can recover gracefully from failures, making it more reliable for short interruptions for production environments.</p><footer class=footline><span class="badge cstyle note badge-with-title"><span class=badge-title class=text-muted>Last Modified
</span><span class=badge-content>Jan 21, 2025</span></span></footer></article></section></div></main></div><script src=/observability-workshop/v5.76/js/clipboard.min.js?1737480558 defer></script><script src=/observability-workshop/v5.76/js/perfect-scrollbar.min.js?1737480558 defer></script><script src=/observability-workshop/v5.76/js/theme.js?1737480558 defer></script></body></html>